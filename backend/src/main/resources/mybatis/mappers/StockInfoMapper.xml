<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.boot.dao.StockInfoDAO">
	<!-- 종목 자동완성 검색 -->
<!--    <select id="searchStocks" parameterType="string" resultType="com.boot.dto.StockInfoDTO">-->
<!--        SELECT STOCK_CODE, STOCK_NAME, MARKET_TYPE, INDUSTRY, PRICE,-->
<!--      		   PRICE_CHANGE, CHANGE_RATE, MARKET_CAP, UPDATED_AT-->
<!--        FROM STOCK_INFO-->
<!--        WHERE STOCK_NAME LIKE '%' || #{keyword} || '%'-->
<!--        ORDER BY STOCK_NAME-->
<!--    </select>-->

    <!-- 1. 종목 검색 (띄어쓰기 무시 기능 추가) -->
    <select id="searchStocks" parameterType="string" resultType="com.boot.dto.StockInfoDTO">
        SELECT *
        FROM STOCK_INFO
        WHERE 
            <!-- (1) 띄어쓰기 제거 후 검색 (REPLACE 사용) -->
            <!-- 검색어와 종목명 모두에서 공백을 제거한 후 비교 -->
            UPPER(REPLACE(STOCK_NAME, ' ', '')) LIKE '%' || UPPER(REPLACE(#{keyword}, ' ', '')) || '%'
            OR UPPER(STOCK_CODE) LIKE '%' || UPPER(REPLACE(#{keyword}, ' ', '')) || '%'
            <!-- 원본 검색어도 함께 검색 (띄어쓰기 있는 경우도 지원) -->
            OR UPPER(STOCK_NAME) LIKE '%' || UPPER(#{keyword}) || '%'
        ORDER BY 
            <!-- (2) 정렬 우선순위 알고리즘 -->
            <!-- 1순위: 검색어와 종목명이 정확히 일치하는 경우 (띄어쓰기 무시) -->
            CASE WHEN UPPER(REPLACE(STOCK_NAME, ' ', '')) = UPPER(REPLACE(#{keyword}, ' ', '')) THEN 0 ELSE 1 END,
            
            <!-- 2순위: 검색어로 시작하는 경우 (띄어쓰기 무시) -->
            CASE WHEN UPPER(REPLACE(STOCK_NAME, ' ', '')) LIKE UPPER(REPLACE(#{keyword}, ' ', '')) || '%' THEN 0 ELSE 1 END,
            
            <!-- 3순위: 원본 검색어로 시작하는 경우 -->
            CASE WHEN UPPER(STOCK_NAME) LIKE UPPER(#{keyword}) || '%' THEN 0 ELSE 1 END,
            
            <!-- 4순위: 시가총액이 큰 순서 (ETF보다 대기업이 먼저 나오게 함) -->
            <!-- 시총이 문자열(5,000억)로 저장되어 있다면 숫자로 변환해서 정렬 -->
            TO_NUMBER(REGEXP_REPLACE(MARKET_CAP, '[^0-9]', '')) DESC
    </select>

    <!-- 2. 뉴스 검색 (띄어쓰기 무시 기능 추가) -->
    <!-- 제목이나 내용에 키워드가 있는 뉴스 검색 -->
    <select id="searchNews" parameterType="string" resultType="com.boot.dto.StockNewsDTO">
        SELECT *
        FROM (
            SELECT * FROM STOCK_NEWS
            WHERE 
                <!-- 띄어쓰기 제거 후 검색 -->
                UPPER(REPLACE(TITLE, ' ', '')) LIKE '%' || UPPER(REPLACE(#{keyword}, ' ', '')) || '%'
                OR UPPER(REPLACE(CONTENT, ' ', '')) LIKE '%' || UPPER(REPLACE(#{keyword}, ' ', '')) || '%'
                <!-- 원본 검색어도 함께 검색 -->
                OR UPPER(TITLE) LIKE '%' || UPPER(#{keyword}) || '%'
                OR UPPER(CONTENT) LIKE '%' || UPPER(#{keyword}) || '%'
            ORDER BY NEWS_DATE DESC
        )
        WHERE ROWNUM &lt;= 10 <!-- 너무 많으면 느리니까 10개만 -->
    </select>



    <!-- 상세 정보 -->
    <select id="getStockDetail" parameterType="string" resultType="com.boot.dto.StockInfoDTO">
        SELECT STOCK_CODE, STOCK_NAME, MARKET_TYPE, INDUSTRY, PRICE,
       		   PRICE_CHANGE, CHANGE_RATE, MARKET_CAP, UPDATED_AT
        FROM STOCK_INFO
        WHERE STOCK_CODE = #{stockCode}
    </select>

	<select id="selectTop100MarketCapPaged" resultType="com.boot.dto.StockInfoDTO">
	    SELECT *
	    FROM (
	        SELECT inner_q.*, ROWNUM AS rn
	        FROM (
	            SELECT
	                STOCK_CODE,
	                STOCK_NAME,
	                MARKET_TYPE,
	                INDUSTRY,
	                PRICE,
	                PRICE_CHANGE,
	                CHANGE_RATE,
	                MARKET_CAP,
	                UPDATED_AT
	            FROM STOCK_INFO
	            ORDER BY TO_NUMBER(REPLACE(MARKET_CAP, ',', '')) DESC
	        ) inner_q
	        WHERE ROWNUM &lt;= #{end}
	    )
	    WHERE rn &gt;= #{start}
	</select>





    
    <select id="selectTopRisingStocks" resultType="com.boot.dto.StockInfoDTO">
    SELECT * FROM (
        SELECT
            STOCK_CODE, 
            STOCK_NAME, 
            CHANGE_RATE
        FROM
            STOCK_INFO
        ORDER BY
            CHANGE_RATE DESC
    )
    WHERE ROWNUM &lt;= 3  </select>
    
    <select id="selectTopFallingStocks" resultType="com.boot.dto.StockInfoDTO">
    SELECT * FROM (
        SELECT
            STOCK_CODE, 
            STOCK_NAME, 
            CHANGE_RATE
        FROM
            STOCK_INFO
        ORDER BY
            CHANGE_RATE ASC  )
    WHERE ROWNUM &lt;= 3
</select>
</mapper>
